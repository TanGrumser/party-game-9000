name: Build and Deploy

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # ========== BUILD PHASE ==========

      - name: Build backend Docker image
        run: docker build -t party-game .

      - name: Godot Export (Web)
        uses: firebelley/godot-export@v7.0.0
        with:
          godot_executable_download_url: https://github.com/godotengine/godot/releases/download/4.2.2-stable/Godot_v4.2.2-stable_linux.x86_64.zip
          godot_export_templates_download_url: https://github.com/godotengine/godot/releases/download/4.2.2-stable/Godot_v4.2.2-stable_export_templates.tpz
          relative_project_path: godot
          presets_to_export: Web
          archive_output: false
          use_preset_export_path: true

      # ========== DEPLOY PHASE (only runs if both builds succeed) ==========

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key

      - name: Transfer backend image
        run: |
          docker save party-game | gzip > party-game.tar.gz
          scp -o StrictHostKeyChecking=no -i ~/.ssh/deploy_key -P ${{ secrets.SERVER_SSH_PORT }} \
            party-game.tar.gz \
            ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }}:~/party-game.tar.gz

      - name: Deploy backend
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.SERVER_HOST }}
          port: ${{ secrets.SERVER_SSH_PORT }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            set -e
            gunzip -c ~/party-game.tar.gz | docker load
            rm ~/party-game.tar.gz

            docker stop party-game || true
            docker rm party-game || true

            docker run -d \
              --name party-game \
              --network proxy \
              --restart unless-stopped \
              party-game

      - name: Deploy frontend
        run: |
          ssh -i ~/.ssh/deploy_key -p ${{ secrets.SERVER_SSH_PORT }} -o StrictHostKeyChecking=no \
            ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} "mkdir -p /srv/www/party-game"

          rsync -az --delete -e "ssh -i ~/.ssh/deploy_key -p ${{ secrets.SERVER_SSH_PORT }} -o StrictHostKeyChecking=no" \
            godot/build/web/ \
            ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }}:/srv/www/party-game/
